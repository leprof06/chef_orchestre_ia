<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Chef d'Orchestre IA</title>
  <style>
    body { font-family: Arial, sans-serif; background: #f4f4f4; padding: 2em; }
    .container { background: white; padding: 2em; border-radius: 8px; max-width: 1000px; margin: auto; }
    #chat { border: 1px solid #ccc; padding: 1em; height: 300px; overflow-y: scroll; margin-bottom: 1em; background: #fafafa; }
    .message { margin-bottom: 0.5em; }
    .user { font-weight: bold; color: #333; }
    .bot { color: #007BFF; }
    .btns { margin-bottom: 1em; }
    #fileList { margin-top: 1em; max-height: 200px; overflow-y: scroll; background: #f0f0f0; padding: 1em; border: 1px solid #ccc; }
    textarea { width: 100%; height: 300px; margin-top: 1em; }
  </style>
</head>
<body>
  <div class="container">
    <h2>👋 Bonjour ! Sur quoi travaillons-nous aujourd'hui ?</h2>
    <div class="btns">
      <input type="file" id="projectFile" />
      <button onclick="uploadProject()">Analyser un projet</button>
      <button onclick="togglePause()">Pause / Play</button>
    </div>
    <div id="chat"></div>
    <input type="text" id="userInput" placeholder="Décrivez votre projet ici..." style="width: 80%;" />
    <button onclick="sendMessage()">Envoyer</button>

    <h3>🗂 Fichiers disponibles</h3>
    <div id="fileList"></div>
    <h3>📄 Éditeur de fichier</h3>
    <select id="fileSelector" onchange="loadFile()"></select>
    <textarea id="fileEditor"></textarea>
    <button onclick="saveFile()">💾 Sauvegarder les modifications</button>
  </div>

  <script>
    function appendMessage(sender, text) {
      const chat = document.getElementById("chat");
      const div = document.createElement("div");
      div.className = "message";
      div.innerHTML = `<span class="${sender}">${sender}:</span> ${text}`;
      chat.appendChild(div);
      chat.scrollTop = chat.scrollHeight;
    }

    function sendMessage() {
      const input = document.getElementById("userInput");
      const text = input.value;
      if (!text) return;
      appendMessage("user", text);
      input.value = "";
      fetch("/run", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ task: text })
      })
      .then(res => res.json())
      .then(data => appendMessage("bot", data.result || "Pas de réponse."));
    }

    function uploadProject() {
      const fileInput = document.getElementById("projectFile");
      const file = fileInput.files[0];
      if (!file) return;
      const formData = new FormData();
      formData.append("project", file);
      appendMessage("user", `Analyse le projet ${file.name}`);
      fetch("/upload", {
        method: "POST",
        body: formData
      })
      .then(res => res.json())
      .then(data => appendMessage("bot", data.result || "Analyse terminée sans réponse."));
    }

    function togglePause() {
      fetch("/toggle_pause", { method: "POST" })
        .then(res => res.json())
        .then(data => appendMessage("bot", `⏸ Pause ${data.paused ? 'activée' : 'désactivée'}`));
    }

    function loadFileList() {
      fetch("/files")
        .then(res => res.json())
        .then(data => {
          const selector = document.getElementById("fileSelector");
          selector.innerHTML = "";
          data.files.forEach(f => {
            const option = document.createElement("option");
            option.value = f;
            option.textContent = f;
            selector.appendChild(option);
          });
          if (data.files.length) loadFile();
        });
    }

    function loadFile() {
      const file = document.getElementById("fileSelector").value;
      fetch(`/file?path=${encodeURIComponent(file)}`)
        .then(res => res.json())
        .then(data => {
          document.getElementById("fileEditor").value = data.content || "";
        });
    }

    function saveFile() {
      const file = document.getElementById("fileSelector").value;
      const content = document.getElementById("fileEditor").value;
      fetch("/file", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ path: file, content })
      })
      .then(res => res.json())
      .then(data => appendMessage("bot", data.result || "Sauvegarde réussie."));
    }

    window.onload = loadFileList;
  </script>
</body>
</html>
